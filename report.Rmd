---
title: "Isokinetic strength data processing report"
author: "Lucas Veras"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    number_sections: true
    highlight: tango
    code_folding: "hide"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r prepare, include=FALSE}
library(tidyverse)
source("code/functions/read_strength_data.R")
source("code/functions/plot_divisions.R")
source("code/functions/separate_file.R")
source("code/functions/quality_control.R")
source("code/functions/count_reps.R")
source("code/functions/detect_ROM.R")
source("code/functions/correct_ROM.R")
source("code/functions/compute_variables.R")
```

# Introduction 

The present report shows the processing of isokinetic strength raw data test from the BaSEIB Clinical Trial. The tests were performed using an isokinetic dynamometer (Biodex System 4 Pro), with a dynamic concentric muscle strength test for knee and trunk muscles. The protocols were:

**A) Knee muscle strength test**

The range of motion was 90º. Two isokinetic speeds were used:

  - 4 repetitions at 60º/s
  - 8 repetitions at 180º/s
  
**B) Trunk muscle strength test**

The range of motion was 60º. Two isokinetic speeds were used:

  - 4 repetitions at 60º/s
  - 6 repetitions at 120º/s
  
There was a 2 minutes rest period between the 2 velocities tests.

The manufacturer-supplied software (Biodex Advantage Software, V.4X) was used to download the raw data. Knee muscle strength test was also corrected for gravity by the software.

Throughout the rest of this document, the examples of code and plots used will be referred to the knee muscle strength tests. The Github repository with the code for these analysis can be found [here](https://github.com/verasls/BaSEIB_isokinetic_strength).

# Separate repetitions

First of all, we needed to accurately determine the start and end points of each of the test "half" repetitions. A “half” repetition in the away direction (e.g. knee extension) and a “half” repetition in the towards direction (e.g. knee flexion) constitutes a whole repetition. As stated by the Biodex Advantage Sotware (V.4X) Operation Manual, the dinamometer velocity signal is the most reliable source for determination of half repetitions, as they contain information about both the velocity magnitude and direction. Therefore, the function `find_divisions()` was defined to scan the velocity signal and mark all points of zero crossings, in other words, where the velocity signal changes sign. These points would be further processed to ensure that they correspond to the exact limits of the half repetition, and not generated by signal noise.

The figure below shows a raw torque X time plot for the isokinetic testing of knee muscle strength at 60º/s.

```{r strength_plot, fig.height=4, fig.width=9, dev='svg'}

D <- read_strength_data(
  "data/raw/knee/60gs/1st_eval/1st_strength_knee_raw_60g_001.txt"
  )

ggplot(data = D) +
    geom_line(mapping = aes(x = time, y = torque), colour = "blue") +
    labs(
      x = "Time (ms)",
      y = expression(Torque~(N*"\U00B7"*m)),
      title = "1st eval ID 001 - knee 60º/s"
    ) + 
    theme(plot.title = element_text(hjust = 0.5))
```

The figure below show the same plot as above, but with the vertical black lines representing the start and end points of each half repetition, as determined by the `find_divisions()` function.

```{r divisions_plot, fig.height=4, fig.width=9, dev='svg'}
plot_divisions(
  file = "data/raw/knee/60gs/1st_eval/1st_strength_knee_raw_60g_001.txt", 
  save = FALSE
  )
```

All the torque X time plots with the half repetition divisions were saved into separate files to manually inspect for any possible errors.

# Quality control

The next step was the application of the `quality_control()` function, to further ensure that there are no errors in the process of spliting the test data into the half repetitions. This function takes into account the "type" of half repetition, either extension or flexion, and checks whether there are any errors in the torque and velocity signals sign, and also in the anatomic position angle, using the following criteria:

**Knee extension**

- Torque and velocity signals should be positive values
- Anatomic position angles should decrease during the half repetition

**Knee flexion**

- Torque and velocity signals should be negative values
- Anatomic position angles should increase during the half repetition

The `quality_control()` function have also an argument that allows the user to specify the range of motion (ROM; start and end points in degrees) at which the function will inspect the file. At these analysis the ROM is set from 10º to 80º `(10:80)`. The function, then, returns information when the subject`s ROM does not match the selected range.

The quality control process continues with the utilization of the `count_reps()` function, which, as the name states, counts the number of repetitions in a given test, and then returns which subjects present a number of repetitions different than the expected for the test.

The final step is to correct the anatomic position values of some subjects that were shown to present errors in the ROM. In all of the cases analyzed, even though the subjects presented anatomic position values different than expected for the test, the equipment postition presented the correct ROM. Therefore, the wrong anatomic position is due to an error in the equipment configuration before the test. In this cases, the `correct_ROM()` function was used to reset the anatomic position to their actual value.